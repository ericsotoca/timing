<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculatrice</title>
    <meta name="description" content="Une application de calculatrice simple et efficace.">
    <meta name="theme-color" content="#ffffff">

    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhbGN1bGF0cmljZSIsCiAgInNob3J0X25hbWUiOiAiQ2FsYyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmVmZWZlIiwKICAidGhlbWVfY29sb3IiOiAiI2ZlZmVmZSIsCiAgImRlc2NyaXB0aW9uIjogIlV◊í◊¢IGNhbGN1bGF0cmljZSBzaW1wbGUuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaWNvbi0xOTJ4MTkyLnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJpY29uLTUxMng1MTIucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --main-color: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --operator-bg: #f79526;
            --number-bg: #e0e0e0;
            --special-bg: #d6d6d6;
            --event-r-color: #007bff;
            --event-o-color: #ff9800;
            --star-color: #f39c12;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        .app-container {
            width: 100%; max-width: 400px;
            height: 100%; max-height: 700px;
            background: var(--main-color);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        #calculator-app { display: flex; flex-direction: column; height: 100%; }
        .calc-display {
            background-color: #2a2a2a; color: white;
            font-size: 2.8em; text-align: right; padding: 20px;
            flex: 1; display: flex; align-items: flex-end; justify-content: flex-end;
            word-wrap: break-word; word-break: break-all;
        }
        .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background-color: #ccc; }
        .calc-keys button {
            background-color: var(--number-bg); border: none; font-size: 1.5em;
            padding: 20px 0; cursor: pointer; transition: background-color 0.2s;
        }
        .calc-keys button:active { background-color: #c0c0c0; }
        .calc-keys .operator { background-color: var(--operator-bg); color: white; }
        .calc-keys .special { background-color: var(--special-bg); }

        #tracker-app { display: flex; flex-direction: column; height: 100%; }
        header { 
            padding: 15px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #eee;
        }
        header h1 { font-size: 1.5em; }
        #lock-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        nav { display: flex; justify-content: space-around; background: #f9f9f9; padding: 10px 0; }
        nav button { background: none; border: none; font-size: 1em; cursor: pointer; color: #777; padding: 5px 10px;}
        nav button.active { color: var(--primary-color); font-weight: bold; border-bottom: 2px solid var(--primary-color); }
        .content-view { flex: 1; overflow-y: auto; padding: 15px; }

        /* NOUVEAU STYLE : Tableau de bord */
        .predictions-container {
            display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px;
        }
        .prediction-card {
            background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center;
        }
        .prediction-card h4 { font-size: 1em; color: #555; margin-bottom: 5px; }
        .prediction-date { font-size: 1.4em; font-weight: bold; margin-bottom: 5px; }
        .prediction-countdown { font-size: 0.9em; color: #777; margin-bottom: 10px; }
        .confidence-stars { font-size: 1.2em; color: var(--star-color); }

        .dashboard-card { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .dashboard-card h3 { margin-bottom: 10px; font-size: 1.1em; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #history-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        #history-list li { padding: 8px 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        #history-list li:last-child { border-bottom: none; }
        #history-list .event-r { color: var(--event-r-color); font-weight: bold; }
        #history-list .event-o { color: var(--event-o-color); font-weight: bold; }
        .supposed-event { font-style: italic; color: #666; } /* Style pour les dates suppos√©es */

        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #calendar-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 5px; }
        #month-year { font-size: 1.2em; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-name { font-weight: bold; color: #999; font-size: 0.8em; }
        .day { padding: 8px 0; cursor: pointer; border-radius: 50%; position: relative; transition: background-color 0.2s; }
        .day:hover { background-color: #f0f0f0; }
        .day.today { background-color: var(--primary-color); color: white; font-weight: bold;}
        .day.empty { visibility: hidden; }
        .event-dot { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; }
        .r-dot { background-color: var(--event-r-color); }
        .o-dot { background-color: var(--event-o-color); }

        .settings-group { margin-bottom: 20px; }
        .settings-group label { display: block; margin-bottom: 5px; }
        .settings-group input, .settings-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: var(--primary-color); color: white; width: 100%; margin-top: 10px; font-size: 1em; }
        .btn-danger { background-color: #dc3545; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; }
        .modal-content h2 { margin-bottom: 15px; }
        .modal-content input { width: 100%; padding: 10px; margin-bottom: 10px; text-align: center; font-size: 1.2em; }
        .modal-content p { margin-bottom: 15px; color: #666; }
        #day-modal-events button { margin: 5px; padding: 8px 12px; }
        #day-modal-note { width: 100%; height: 60px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="app-container">

        <div id="calculator-app">
            <div id="calc-display" class="calc-display">0</div>
            <div class="calc-keys">
                <button class="special" data-key="clear">AC</button><button class="special" data-key="backspace">‚å´</button><button class="special" data-key="%">%</button><button class="operator" data-key="/">√∑</button>
                <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button class="operator" data-key="*">√ó</button>
                <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button class="operator" data-key="-">-</button>
                <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button class="operator" data-key="+">+</button>
                <button data-key="0" style="grid-column: span 2;">0</button><button data-key=".">.</button><button class="operator" data-key="=">=</button>
            </div>
        </div>

        <div id="tracker-app" class="hidden">
            <header>
                <h1>Tableau de bord</h1>
                <button id="lock-btn">üîí</button>
            </header>
            
            <nav>
                <button class="nav-btn active" data-view="dashboard">Tableau de bord</button>
                <button class="nav-btn" data-view="calendar">Calendrier</button>
                <button class="nav-btn" data-view="settings">Param√®tres</button>
            </nav>

            <div id="dashboard-view" class="content-view">
                <div id="predictions-container" class="predictions-container">
                    <!-- Les cartes de pr√©diction seront inject√©es ici par JavaScript -->
                </div>
                <div class="dashboard-card">
                    <h3>Historique des √©v√©nements</h3>
                    <ul id="history-list">
                        <li>Aucune donn√©e.</li>
                    </ul>
                </div>
            </div>

            <div id="calendar-view" class="content-view hidden">
                <div id="calendar-header">
                    <button id="prev-month">‚óÑ</button>
                    <span id="month-year"></span>
                    <button id="next-month">‚ñ∫</button>
                </div>
                <div class="calendar-grid" id="day-names"></div>
                <div class="calendar-grid" id="calendar-days"></div>
            </div>

            <div id="settings-view" class="content-view hidden">
                 <div class="settings-group">
                    <label for="luteal-phase-duration">Dur√©e phase post-signal (jours)</label>
                    <input type="number" id="luteal-phase-duration" value="14" min="10" max="20">
                </div>
                <button id="save-settings-btn" class="btn">Enregistrer Param√®tres</button>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <div class="settings-group">
                    <h3>Exporter / Sauvegarder</h3>
                    <textarea id="export-data-field" readonly rows="4"></textarea>
                    <button id="export-btn" class="btn">G√©n√©rer le code d'export</button>
                </div>
                 <div class="settings-group">
                    <h3>Importer une Sauvegarde</h3>
                    <textarea id="import-data-field" rows="4"></textarea>
                    <button id="import-btn" class="btn">Importer</button>
                </div>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <button id="reset-app-btn" class="btn btn-danger">R√©initialiser l'application</button>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="setup-modal" class="modal-overlay hidden"><div class="modal-content"><h2 id="setup-title">D√©finir votre code secret</h2><p id="setup-instruction">Entrez un code √† 4 chiffres.</p><input type="password" id="pincode-input" maxlength="4" pattern="\d*" inputmode="numeric"><button id="pincode-submit" class="btn">D√©finir</button></div></div>
    <div id="onboarding-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Configuration Initiale</h2><p>Pour commencer, nous allons ajouter votre historique d'√©v√©nements "Mode M" (R).</p><button id="start-onboarding-btn" class="btn">Commencer</button></div></div>
    <div id="day-modal" class="modal-overlay hidden"><div class="modal-content"><h2 id="day-modal-title"></h2><div id="day-modal-events"><button id="add-r-event" class="btn">Ajouter Mode M (R)</button><button id="add-o-event" class="btn" style="background-color: var(--event-o-color);">Ajouter Signal S (O)</button><button id="remove-event" class="btn btn-danger">Supprimer l'√©v√©nement</button></div><textarea id="day-modal-note" placeholder="Ajouter une note..."></textarea><button id="save-day-btn" class="btn">Enregistrer</button><button id="close-day-modal-btn" class="btn" style="background: #6c757d; margin-top:5px;">Fermer</button></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const APP_DATA_KEY = 'discreetAppData_v3';
            const PIN_KEY = 'discreetAppPin_v3';
            let inactivityTimer;

            let state = {
                currentDate: new Date(),
                events: {},
                settings: { lutealPhase: 14 }
            };

            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            // --- FONCTIONS DE STOCKAGE ---
            const saveData = () => localStorage.setItem(APP_DATA_KEY, JSON.stringify(state));
            const loadData = () => {
                const data = localStorage.getItem(APP_DATA_KEY);
                if (data) {
                    const loadedState = JSON.parse(data);
                    state = { ...state, ...loadedState, settings: { ...state.settings, ...loadedState.settings } };
                    state.currentDate = new Date(state.currentDate);
                }
                $('#luteal-phase-duration').value = state.settings.lutealPhase;
            };

            // --- LOGIQUE DE L'APPLICATION (VERROUILLAGE, NAVIGATION) ---
            const lockApp = () => {
                $('#tracker-app').classList.add('hidden');
                $('#calculator-app').classList.remove('hidden');
                $('#calc-display').textContent = '0';
                clearTimeout(inactivityTimer);
            };
            const unlockApp = () => {
                $('#calculator-app').classList.add('hidden');
                $('#tracker-app').classList.remove('hidden');
                navigateTo('dashboard');
                startInactivityTimer();
            };
            const startInactivityTimer = () => {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(lockApp, 5 * 60 * 1000);
            };
            const resetInactivityTimer = () => startInactivityTimer();
            
            const navigateTo = (viewName) => {
                const viewTitles = { dashboard: 'Tableau de bord', calendar: 'Calendrier', settings: 'Param√®tres' };
                $('header h1').textContent = viewTitles[viewName];
                $$('.content-view').forEach(v => v.classList.add('hidden'));
                $(`#${viewName}-view`).classList.remove('hidden');
                $$('.nav-btn').forEach(b => b.classList.remove('active'));
                $(`.nav-btn[data-view="${viewName}"]`).classList.add('active');

                if (viewName === 'dashboard') renderDashboard();
                if (viewName === 'calendar') renderCalendar();
            };
            
            // --- NOUVEAU : LOGIQUE DE PR√âDICTIONS AVANC√âES ---

            /**
             * Calcule l'√©cart type d'un tableau de nombres.
             * @param {number[]} arr - Le tableau des dur√©es de cycle.
             * @returns {number} L'√©cart type.
             */
            const getStandardDeviation = (arr) => {
                if (arr.length < 2) return 0;
                const n = arr.length;
                const mean = arr.reduce((a, b) => a + b) / n;
                return Math.sqrt(arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n);
            };

            /**
             * Calcule un indice de confiance bas√© sur le nombre de cycles et leur r√©gularit√©.
             * @param {number} cycleCount - Le nombre de cycles complets.
             * @param {number} stdDev - L'√©cart type des dur√©es de cycle.
             * @returns {number} Un score de 1 √† 5.
             */
            const calculateConfidence = (cycleCount, stdDev) => {
                // Score bas√© sur la quantit√© de donn√©es (max 2.5 √©toiles)
                let dataScore = 0.5;
                if (cycleCount >= 2) dataScore = 1;
                if (cycleCount >= 3) dataScore = 1.5;
                if (cycleCount >= 4) dataScore = 2;
                if (cycleCount >= 6) dataScore = 2.5;

                // Score bas√© sur la r√©gularit√© (max 2.5 √©toiles)
                let consistencyScore = 0.5;
                if (stdDev <= 7) consistencyScore = 1;
                if (stdDev <= 5) consistencyScore = 1.5;
                if (stdDev <= 3) consistencyScore = 2;
                if (stdDev <= 1.5) consistencyScore = 2.5;
                
                return Math.max(1, dataScore + consistencyScore); // Minimum 1 √©toile
            };

            /**
             * G√©n√®re une cha√Æne de caract√®res repr√©sentant les √©toiles.
             * @param {number} score - Le score de confiance (1-5).
             * @returns {string} La cha√Æne HTML des √©toiles.
             */
            const renderStars = (score) => {
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    stars += i <= score ? '‚òÖ' : '‚òÜ';
                }
                return stars;
            };

            // --- VUE TABLEAU DE BORD (MISE √Ä JOUR MAJEURE) ---
            const renderDashboard = () => {
                const predictionsContainer = $('#predictions-container');
                const historyList = $('#history-list');
                predictionsContainer.innerHTML = '';
                historyList.innerHTML = '';

                const rEvents = Object.keys(state.events)
                    .filter(date => state.events[date].type === 'R')
                    .sort((a, b) => new Date(a) - new Date(b));

                if (rEvents.length < 2) {
                    predictionsContainer.innerHTML = `<p style="text-align:center; color: #666;">Ajoutez au moins deux "Mode M" pour activer les pr√©dictions.</p>`;
                    return;
                }

                // --- Calculs de base ---
                const cycleLengths = [];
                for (let i = 1; i < rEvents.length; i++) {
                    const diff = new Date(rEvents[i]) - new Date(rEvents[i-1]);
                    cycleLengths.push(diff / (1000 * 60 * 60 * 24));
                }
                const avgCycle = cycleLengths.reduce((a, b) => a + b, 0) / cycleLengths.length;
                const stdDev = getStandardDeviation(cycleLengths);
                const confidence = calculateConfidence(cycleLengths.length, stdDev);
                const starsHTML = renderStars(confidence);
                
                // --- G√©n√©ration des pr√©dictions futures ---
                const lastRDate = new Date(rEvents[rEvents.length - 1]);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const futurePredictions = [];
                let currentR = new Date(lastRDate);

                // On g√©n√®re plusieurs pr√©dictions futures pour √™tre s√ªr d'en avoir 2 apr√®s "aujourd'hui"
                for (let i = 0; i < 4; i++) {
                    currentR.setDate(currentR.getDate() + Math.round(avgCycle));
                    let predictedO = new Date(currentR);
                    predictedO.setDate(predictedO.getDate() - state.settings.lutealPhase);
                    
                    if(currentR >= today) futurePredictions.push({ type: 'R', date: new Date(currentR) });
                    if(predictedO >= today) futurePredictions.push({ type: 'O', date: new Date(predictedO) });
                }

                const nextTwoEvents = futurePredictions.sort((a, b) => a.date - b.date).slice(0, 2);

                // --- Affichage des pr√©dictions ---
                nextTwoEvents.forEach(event => {
                    const eventName = event.type === 'R' ? 'Prochain Mode M' : 'Prochain Signal S';
                    const eventColor = event.type === 'R' ? 'var(--event-r-color)' : 'var(--event-o-color)';
                    const diffTime = event.date - today;
                    const daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    predictionsContainer.innerHTML += `
                        <div class="prediction-card">
                            <h4>${eventName}</h4>
                            <div class="prediction-date" style="color: ${eventColor}">${event.date.toLocaleDateString('fr-FR')}</div>
                            <div class="prediction-countdown">Dans environ ${daysRemaining} jour(s)</div>
                            <div class="confidence-stars" title="Indice de confiance : ${confidence.toFixed(1)}/5">${starsHTML}</div>
                        </div>
                    `;
                });

                // --- NOUVEAU : Construction de l'historique avec ovulations suppos√©es ---
                let combinedHistory = [];
                // 1. Ajouter les √©v√©nements r√©els
                for (const dateStr in state.events) {
                    combinedHistory.push({ ...state.events[dateStr], date: new Date(dateStr), isSupposed: false });
                }
                // 2. Ajouter les ovulations pass√©es suppos√©es
                for (let i = 1; i < rEvents.length; i++) {
                    const endDate = new Date(rEvents[i]);
                    let supposedODate = new Date(endDate);
                    supposedODate.setDate(supposedODate.getDate() - state.settings.lutealPhase);
                    // On ne l'ajoute que s'il n'y a pas d√©j√† un √©v√©nement 'O' r√©el ce jour-l√†
                    if (!state.events[supposedODate.toISOString().split('T')[0]]) {
                         combinedHistory.push({ type: 'O', date: supposedODate, isSupposed: true });
                    }
                }
                // 3. Trier et afficher
                combinedHistory.sort((a, b) => b.date - a.date);
                if (combinedHistory.length > 0) {
                    combinedHistory.forEach(item => {
                        const eventName = item.type === 'R' ? 'Mode M' : 'Signal S';
                        const eventClass = item.type === 'R' ? 'event-r' : 'event-o';
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${item.date.toLocaleDateString('fr-FR')}</span>
                            <strong class="${eventClass} ${item.isSupposed ? 'supposed-event' : ''}">
                                ${eventName} ${item.isSupposed ? '*' : ''}
                            </strong>`;
                        historyList.appendChild(li);
                    });
                } else {
                    historyList.innerHTML = '<li>Aucun √©v√©nement enregistr√©.</li>';
                }
            };

            // --- VUE CALENDRIER ---
            const renderCalendar = () => {
                const calendarDays = $('#calendar-days');
                calendarDays.innerHTML = '';
                const { year, month } = { year: state.currentDate.getFullYear(), month: state.currentDate.getMonth() };
                $('#month-year').textContent = state.currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const dayOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

                if($('#day-names').childElementCount === 0) {
                    ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(d => $('#day-names').innerHTML += `<div class="day-name">${d}</div>`);
                }
                for (let i = 0; i < dayOffset; i++) calendarDays.innerHTML += `<div class="day empty"></div>`;

                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'day';
                    dayEl.textContent = day;
                    dayEl.dataset.date = dateStr;

                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                    
                    if (state.events[dateStr]) {
                        const dot = document.createElement('div');
                        dot.className = `event-dot ${state.events[dateStr].type.toLowerCase()}-dot`;
                        dayEl.appendChild(dot);
                    }
                    dayEl.addEventListener('click', () => openDayModal(dateStr));
                    calendarDays.appendChild(dayEl);
                }
            };
            
            // --- GESTION MODALE JOUR ---
            let selectedDateStr = '';
            const openDayModal = (dateStr) => {
                selectedDateStr = dateStr;
                const date = new Date(dateStr + 'T00:00:00');
                $('#day-modal-title').textContent = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                $('#day-modal-note').value = state.events[dateStr]?.note || '';
                $('#day-modal').classList.remove('hidden');
            };
            const closeDayModal = () => $('#day-modal').classList.add('hidden');
            const saveDayData = (type) => {
                const note = $('#day-modal-note').value;
                const existingEvent = state.events[selectedDateStr];
                if (type) {
                    state.events[selectedDateStr] = { ...existingEvent, type: type, note: note };
                } else if (note.trim()) {
                    state.events[selectedDateStr] = { ...existingEvent, note: note };
                }
                if (state.events[selectedDateStr] && !state.events[selectedDateStr].type && !state.events[selectedDateStr].note) {
                    delete state.events[selectedDateStr];
                }
                saveData();
                renderCalendar();
            };

            // --- INITIALISATION & BINDING ---
            const init = () => {
                document.body.addEventListener('click', resetInactivityTimer);
                document.body.addEventListener('keypress', resetInactivityTimer);
                $('#lock-btn').addEventListener('click', lockApp);
                $$('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));
                
                $('#prev-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); });
                $('#next-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); });

                // Modal
                $('#add-r-event').addEventListener('click', () => { saveDayData('R'); closeDayModal(); });
                $('#add-o-event').addEventListener('click', () => { saveDayData('O'); closeDayModal(); });
                $('#remove-event').addEventListener('click', () => { delete state.events[selectedDateStr]; saveData(); renderCalendar(); closeDayModal(); });
                $('#save-day-btn').addEventListener('click', () => { saveDayData(state.events[selectedDateStr]?.type); closeDayModal(); });
                $('#close-day-modal-btn').addEventListener('click', closeDayModal);

                // Param√®tres
                $('#save-settings-btn').addEventListener('click', () => { state.settings.lutealPhase = parseInt($('#luteal-phase-duration').value) || 14; saveData(); alert('Param√®tres enregistr√©s !'); });
                $('#export-btn').addEventListener('click', () => { $('#export-data-field').value = JSON.stringify({state: state, pin: localStorage.getItem(PIN_KEY)}); alert('Code de sauvegarde g√©n√©r√©.'); });
                $('#import-btn').addEventListener('click', () => {
                    if(!confirm("Importer ces donn√©es √©crasera vos donn√©es actuelles. Continuer ?")) return;
                    try {
                        const dataToImport = JSON.parse($('#import-data-field').value);
                        localStorage.setItem(APP_DATA_KEY, JSON.stringify(dataToImport.state));
                        localStorage.setItem(PIN_KEY, dataToImport.pin);
                        alert('Importation r√©ussie !'); location.reload();
                    } catch (e) { alert('Erreur lors de l\'importation.'); }
                });
                $('#reset-app-btn').addEventListener('click', () => {
                    if (confirm("Voulez-vous vraiment tout r√©initialiser ?")) { localStorage.clear(); location.reload(); }
                });
                
                // Calculatrice
                $('.calc-keys').addEventListener('click', (e) => {
                    if (!e.target.matches('button')) return;
                    const key = e.target.dataset.key;
                    const display = $('#calc-display');
                    switch (key) {
                        case 'clear': display.textContent = '0'; break;
                        case 'backspace': display.textContent = display.textContent.slice(0, -1) || '0'; break;
                        case '=':
                            if (display.textContent === localStorage.getItem(PIN_KEY)) unlockApp();
                            else try { display.textContent = eval(display.textContent.replace(/√ó/g, '*').replace(/√∑/g, '/')) || '0'; } catch { display.textContent = 'Erreur'; }
                            break;
                        default:
                            if (display.textContent === '0' && !'*/+-%'.includes(key)) display.textContent = '';
                            display.textContent += e.target.textContent;
                    }
                });

                // Premier lancement
                if (!localStorage.getItem(PIN_KEY)) {
                    $('#setup-modal').classList.remove('hidden');
                } else { loadData(); }
                $('#pincode-submit').addEventListener('click', () => {
                    const pin = $('#pincode-input').value;
                    if (pin.length === 4 && /^\d+$/.test(pin)) {
                        localStorage.setItem(PIN_KEY, pin);
                        $('#setup-modal').classList.add('hidden');
                        if (Object.keys(state.events).length === 0) $('#onboarding-modal').classList.remove('hidden');
                    } else alert("Code invalide.");
                });
                $('#start-onboarding-btn').addEventListener('click', () => {
                    ['2025-09-07', '2025-10-01', '2025-10-27'].forEach(date => { state.events[date] = { type: 'R', note: 'Import initial' }; });
                    saveData();
                    $('#onboarding-modal').classList.add('hidden');
                    alert('Configuration termin√©e !');
                });
            };

            init();
        });
    </script>

</body>
</html>
```
