<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculatrice</title>
    <meta name="description" content="Une application de calculatrice simple et efficace.">
    <meta name="theme-color" content="#ffffff">

    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhbGN1bGF0cmljZSIsCiAgInNob3J0X25hbWUiOiAiQ2FsYyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmVmZWZlIiwKICAidGhlbWVfY29sb3IiOiAiI2ZlZmVlZSIsCiAgImRlc2NyaXB0aW9uIjogIlV◊í◊¢IGNhbGN1bGF0cmljZSBzaW1wbGUuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaWNvbi0xOTJ4MTkyLnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJpY29uLTUxMng1MTIucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --main-color: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --operator-bg: #f79526;
            --number-bg: #e0e0e0;
            --special-bg: #d6d6d6;
            --event-r-color: #007bff;
            --event-o-color: #ff9800;
            --event-a-color: #e83e8c;
            --star-color: #f39c12;
            --btn-secondary-bg: #6c757d;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        .app-container {
            width: 100%; max-width: 400px;
            height: 100%; max-height: 700px;
            background: var(--main-color);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        #calculator-app { display: flex; flex-direction: column; height: 100%; }
        .calc-display {
            background-color: #2a2a2a; color: white;
            font-size: 2.8em; text-align: right; padding: 20px;
            flex: 1; display: flex; align-items: flex-end; justify-content: flex-end;
            word-wrap: break-word; word-break: break-all;
        }
        .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background-color: #ccc; }
        .calc-keys button { background-color: var(--number-bg); border: none; font-size: 1.5em; padding: 20px 0; cursor: pointer; }
        .calc-keys .operator { background-color: var(--operator-bg); color: white; }
        .calc-keys .special { background-color: var(--special-bg); }

        #tracker-app { display: flex; flex-direction: column; height: 100%; }
        header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        header h1 { font-size: 1.5em; }
        #lock-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        nav { display: flex; justify-content: space-around; background: #f9f9f9; padding: 10px 0; }
        nav button { background: none; border: none; font-size: 0.9em; cursor: pointer; color: #777; padding: 5px 10px;}
        nav button.active { color: var(--primary-color); font-weight: bold; border-bottom: 2px solid var(--primary-color); }
        .content-view { flex: 1; overflow-y: auto; padding: 15px; }

        .predictions-container { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; }
        .prediction-card { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; }
        .prediction-card h4 { font-size: 1em; color: #555; margin-bottom: 5px; }
        .prediction-date { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .prediction-countdown { font-size: 0.9em; color: #777; margin-bottom: 10px; }
        .confidence-stars { font-size: 1.2em; color: var(--star-color); }

        .dashboard-card { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .dashboard-card h3 { margin-bottom: 10px; font-size: 1.1em; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #history-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        #history-list li { padding: 8px 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        #history-list .event-r { color: var(--event-r-color); font-weight: bold; }
        #history-list .event-o { color: var(--event-o-color); font-weight: bold; }
        #history-list .event-a { color: var(--event-a-color); font-weight: bold; }
        .supposed-event { font-style: italic; color: #666; }

        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day { padding: 8px 0; cursor: pointer; border-radius: 50%; position: relative; }
        .day.today { background-color: var(--primary-color); color: white; font-weight: bold;}
        .day.fertile { background-color: #e83e8c1a; border-radius: 0; }
        .dots-container { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); display: flex; gap: 2px; }
        .dot { width: 5px; height: 5px; border-radius: 50%; }
        .r-dot { background-color: var(--event-r-color); }
        .o-dot { background-color: var(--event-o-color); }
        .a-dot { background-color: var(--event-a-color); }

        #journal-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        #journal-table th, #journal-table td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        #journal-table th { background-color: #f9f9f9; }
        #journal-table .event-cell { cursor: pointer; user-select: none; }
        #journal-table .event-cell:hover { background-color: #f0f0f0; }
        .check { font-weight: bold; }
        .check.event-r { color: var(--event-r-color); }
        .check.event-o { color: var(--event-o-color); }
        .check.event-a { color: var(--event-a-color); }
        
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: var(--primary-color); color: white; width: 100%; margin-top: 10px; font-size: 1em; }
        .btn-danger { background-color: #dc3545; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; }
        #day-modal-events { display: flex; flex-direction: column; gap: 8px; }
        #day-modal-events .btn-group { display: flex; gap: 8px; }
        #day-modal-events .btn-group button { flex: 1; }
        #day-modal-note { width: 100%; height: 60px; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="calculator-app">
            <div id="calc-display" class="calc-display">0</div>
            <div class="calc-keys">
                <button class="special" data-key="clear">AC</button><button class="special" data-key="backspace">‚å´</button><button class="special" data-key="%">%</button><button class="operator" data-key="/">√∑</button>
                <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button class="operator" data-key="*">√ó</button>
                <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button class="operator" data-key="-">-</button>
                <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button class="operator" data-key="+">+</button>
                <button data-key="0" style="grid-column: span 2;">0</button><button data-key=".">.</button><button class="operator" data-key="=">=</button>
            </div>
        </div>

        <div id="tracker-app" class="hidden">
            <header><h1>Tableau de bord</h1><button id="lock-btn">üîí</button></header>
            <nav>
                <button class="nav-btn active" data-view="dashboard">Tableau de bord</button>
                <button class="nav-btn" data-view="calendar">Calendrier</button>
                <button class="nav-btn" data-view="journal">Journal</button>
                <button class="nav-btn" data-view="settings">Param√®tres</button>
            </nav>

            <div id="dashboard-view" class="content-view">
                <div class="dashboard-actions" style="text-align: center; margin-bottom: 15px;">
                     <button id="refresh-dashboard-btn" class="btn" style="width: auto; padding: 10px 20px;">üîÑ Actualiser les calculs</button>
                </div>
                <div id="predictions-container" class="predictions-container"></div>
            </div>
            <div id="calendar-view" class="content-view hidden"><div id="calendar-header"><button id="prev-month">‚óÑ</button><span id="month-year"></span><button id="next-month">‚ñ∫</button></div><div class="calendar-grid" id="day-names"></div><div class="calendar-grid" id="calendar-days"></div></div>
            <div id="journal-view" class="content-view hidden"><table id="journal-table"><thead><tr><th>Date</th><th>A</th><th>R</th><th>O</th></tr></thead><tbody></tbody></table></div>
            <div id="settings-view" class="content-view hidden">
                <div class="settings-group">
                    <label for="luteal-phase-duration">Dur√©e phase post-signal (jours)</label>
                    <input type="number" id="luteal-phase-duration" value="14" min="10" max="20">
                </div>
                <button id="save-settings-btn" class="btn">Enregistrer</button>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <div class="settings-group">
                    <h3>Actions</h3>
                    <button id="add-peak-dates-btn" class="btn" style="background-color: var(--event-o-color);">Ajouter les Pics R/O manquants</button>
                </div>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <div class="settings-group">
                    <h3>Exporter / Sauvegarder</h3>
                    <textarea id="export-data-field" readonly rows="4"></textarea>
                    <button id="export-btn" class="btn">G√©n√©rer le code</button>
                </div>
                <div class="settings-group">
                    <h3>Importer une Sauvegarde</h3>
                    <textarea id="import-data-field" rows="4"></textarea>
                    <button id="import-btn" class="btn">Importer</button>
                </div>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <button id="reset-app-btn" class="btn btn-danger">R√©initialiser</button>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="setup-modal" class="modal-overlay hidden"><div class="modal-content"><h2>D√©finir votre code secret</h2><p>Entrez un code √† 4 chiffres.</p><input type="password" id="pincode-input" maxlength="4" pattern="\d*" inputmode="numeric"><button id="pincode-submit" class="btn">D√©finir</button></div></div>
    <div id="onboarding-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Configuration Initiale</h2><p>Ajout de votre historique complet.</p><button id="start-onboarding-btn" class="btn">Commencer</button></div></div>
    <div id="day-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="day-modal-title"></h2>
            <div id="day-modal-events">
                 <div class="btn-group">
                    <button id="add-rd-event" class="btn">Mode Rd (d√©but)</button>
                    <button id="add-rf-event" class="btn" style="background-color: var(--btn-secondary-bg);">Mode Rf (fin)</button>
                 </div>
                 <button id="add-r-event" class="btn" style="background-color: var(--btn-secondary-bg);">Mode R (isol√©)</button>
                 <button id="add-o-event" class="btn" style="background-color: var(--event-o-color);">Mode O</button>
                 <button id="add-a-event" class="btn" style="background-color: var(--event-a-color);">Ajouter Mode A</button>
                 <button id="remove-event" class="btn btn-danger">Supprimer les √©v√©nements</button>
            </div>
            <textarea id="day-modal-note" placeholder="Ajouter une note..."></textarea>
            <button id="save-note-btn" class="btn">Enregistrer</button>
            <button id="close-day-modal-btn" class="btn" style="background: var(--btn-secondary-bg); margin-top:5px;">Fermer</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const APP_DATA_KEY = 'discreetAppData_v13';
            const PIN_KEY = 'discreetAppPin_v13';
            let inactivityTimer;

            let state = {
                currentDate: new Date(),
                events: {},
                settings: { lutealPhase: 14 }
            };

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);

            const saveData = () => localStorage.setItem(APP_DATA_KEY, JSON.stringify(state));
            const loadData = () => {
                const data = localStorage.getItem(APP_DATA_KEY);
                if (data) {
                    const loaded = JSON.parse(data);
                    state = { ...state, ...loaded, settings: { ...state.settings, ...loaded.settings } };
                    state.currentDate = new Date(state.currentDate);
                }
                $('#luteal-phase-duration').value = state.settings.lutealPhase;
            };

            const lockApp = () => { $('#tracker-app').classList.add('hidden'); $('#calculator-app').classList.remove('hidden'); $('#calc-display').textContent = '0'; clearTimeout(inactivityTimer); };
            const unlockApp = () => { $('#calculator-app').classList.add('hidden'); $('#tracker-app').classList.remove('hidden'); navigateTo('dashboard'); startInactivityTimer(); };
            const startInactivityTimer = () => { clearTimeout(inactivityTimer); inactivityTimer = setTimeout(lockApp, 5 * 60 * 1000); };
            const resetInactivityTimer = () => startInactivityTimer();
            
            const navigateTo = (viewName) => {
                const titles = { dashboard: 'Tableau de bord', calendar: 'Calendrier', journal: 'Journal', settings: 'Param√®tres' };
                $('header h1').textContent = titles[viewName];
                $$('.content-view').forEach(v => v.classList.add('hidden'));
                $(`#${viewName}-view`).classList.remove('hidden');
                $$('.nav-btn').forEach(b => b.classList.remove('active'));
                $(`.nav-btn[data-view="${viewName}"]`).classList.add('active');
                if (viewName === 'dashboard') renderDashboard();
                if (viewName === 'calendar') renderCalendar();
                if (viewName === 'journal') renderJournalView();
            };
            
            const getStandardDeviation = (arr) => {
                if (arr.length < 2) return 0;
                const mean = arr.reduce((a, b) => a + b) / arr.length;
                return Math.sqrt(arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / arr.length);
            };

            const calculateConfidence = (cycleCount, stdDev) => {
                let dataScore = (cycleCount >= 6) ? 2.5 : (cycleCount >= 4) ? 2 : (cycleCount >= 3) ? 1.5 : (cycleCount >= 2) ? 1 : 0.5;
                let consistencyScore = (stdDev <= 1.5) ? 2.5 : (stdDev <= 3) ? 2 : (stdDev <= 5) ? 1.5 : (stdDev <= 7) ? 1 : 0.5;
                return Math.max(1, dataScore + consistencyScore);
            };

            const renderStars = (score) => '‚òÖ'.repeat(Math.round(score)) + '‚òÜ'.repeat(5 - Math.round(score));

            const getPredictionData = () => {
                const cycleAnchorEvents = Object.keys(state.events)
                    .filter(date => state.events[date] && state.events[date].types.includes('Rd'))
                    .sort((a, b) => new Date(a) - new Date(b));

                if (cycleAnchorEvents.length < 2) return null;

                const cycleLengths = [];
                for (let i = 1; i < cycleAnchorEvents.length; i++) {
                    const diff = new Date(cycleAnchorEvents[i]) - new Date(cycleAnchorEvents[i - 1]);
                    cycleLengths.push(diff / (1000 * 60 * 60 * 24));
                }
                const avgCycle = cycleLengths.reduce((a, b) => a + b, 0) / cycleLengths.length;
                
                return {
                    avgCycle,
                    lastRDate: new Date(cycleAnchorEvents[cycleAnchorEvents.length - 1]),
                    confidence: calculateConfidence(cycleLengths.length, getStandardDeviation(cycleLengths)),
                    cycleAnchorEvents: cycleAnchorEvents
                };
            };

            const renderDashboard = () => {
                const predictionsContainer = $('#predictions-container');
                predictionsContainer.innerHTML = '';
                
                const today = new Date(); 
                today.setHours(0, 0, 0, 0);

                let allFutureEvents = [];

                // CORRECTION : √âtape 1 - R√©cup√©rer les √©v√©nements futurs saisis manuellement
                for (const dateStr in state.events) {
                    const eventDate = new Date(dateStr + 'T00:00:00');
                    if (eventDate >= today) {
                        if (state.events[dateStr].types.some(t => ['R', 'Rd', 'Rf'].includes(t))) {
                            allFutureEvents.push({ type: 'R', date: eventDate, isManual: true });
                        }
                        if (state.events[dateStr].types.includes('O')) {
                            allFutureEvents.push({ type: 'O', date: eventDate, isManual: true });
                        }
                    }
                }

                const predictionData = getPredictionData();
                if (predictionData) {
                    const { avgCycle, lastRDate, confidence } = predictionData;
                    const starsHTML = renderStars(confidence);
                    const lastRDateObj = new Date(lastRDate);
                    
                    // √âtape 2 - Calculer les pr√©dictions
                    for (let i = 1; i <= 4; i++) {
                        let predictedR = new Date(lastRDateObj);
                        predictedR.setDate(predictedR.getDate() + Math.round(avgCycle * i));

                        let predictedO = new Date(predictedR);
                        predictedO.setDate(predictedO.getDate() - state.settings.lutealPhase);

                        if (predictedR >= today) allFutureEvents.push({ type: 'R', date: predictedR, isManual: false, confidence, starsHTML });
                        if (predictedO >= today) allFutureEvents.push({ type: 'O', date: predictedO, isManual: false, confidence, starsHTML });
                    }
                }
                
                // √âtape 3 - Fusionner, d√©doublonner et trier
                const uniqueEvents = new Map();
                allFutureEvents.sort((a, b) => a.date - b.date);

                for (const event of allFutureEvents) {
                    const key = event.date.toISOString().split('T')[0] + '-' + event.type;
                    if (!uniqueEvents.has(key)) {
                        uniqueEvents.set(key, event);
                    }
                }

                const finalEventsToShow = Array.from(uniqueEvents.values());

                // √âtape 4 - Afficher les 2 √©v√©nements les plus proches
                if (finalEventsToShow.length > 0) {
                    finalEventsToShow.slice(0, 2).forEach(event => {
                        let eventName = event.type === 'R' ? 'Prochain Mode R' : 'Prochain Mode O';
                        if (event.isManual) {
                            eventName += ' (manuel)';
                        }

                        const eventColor = event.type === 'R' ? 'var(--event-r-color)' : 'var(--event-o-color)';
                        const dateString = event.date.toLocaleDateString('fr-FR');
                        
                        const daysToStart = Math.ceil((event.date - today) / (1000 * 60 * 60 * 24));
                        let countdownText = `Commence dans ${daysToStart} jours`;
                        if (daysToStart === 1) countdownText = `Commence demain`;
                        else if (daysToStart === 0) countdownText = `Commence aujourd'hui`;

                        predictionsContainer.innerHTML += `
                            <div class="prediction-card">
                                <h4>${eventName}</h4>
                                <div class="prediction-date" style="color: ${eventColor}">${dateString}</div>
                                <div class="prediction-countdown">${countdownText}</div>
                                ${!event.isManual ? `<div class="confidence-stars" title="Indice de confiance : ${event.confidence.toFixed(1)}/5">${event.starsHTML}</div>` : ''}
                            </div>`;
                    });
                } else if (!predictionData) {
                     predictionsContainer.innerHTML = `<p style="text-align:center; color: #666;">Ajoutez au moins deux "Mode Rd" pour activer les pr√©dictions.</p>`;
                } else {
                    predictionsContainer.innerHTML = `<p style="text-align:center; color: #666;">Aucun √©v√©nement futur proche, manuel ou pr√©dit.</p>`;
                }
            };

            
            const renderJournalView = () => {
                const tableBody = $('#journal-table tbody');
                tableBody.innerHTML = '';
                let logData = {};

                for (const dateStr in state.events) {
                    if (state.events[dateStr] && state.events[dateStr].types) {
                        logData[dateStr] = [...state.events[dateStr].types];
                    }
                }
                
                const startDate = new Date('2025-05-01');
                const sortedDates = Object.keys(logData)
                    .filter(dateStr => new Date(dateStr) >= startDate)
                    .sort((a, b) => new Date(b) - new Date(a));

                sortedDates.forEach(dateStr => {
                    const events = logData[dateStr] || [];
                    const currentDate = new Date(dateStr + 'T00:00:00');
                    const hasA = events.includes('A');
                    const hasR = events.some(type => ['R', 'Rd', 'Rf'].includes(type));
                    const hasO = events.includes('O');

                    tableBody.innerHTML += `
                        <tr>
                            <td>${currentDate.toLocaleDateString('fr-FR')}</td>
                            <td class="event-cell" data-date="${dateStr}" data-event-type="A">${hasA ? '<span class="check event-a">‚úì</span>' : ''}</td>
                            <td class="event-cell" data-date="${dateStr}" data-event-type="R">${hasR ? '<span class="check event-r">‚úì</span>' : ''}</td>
                            <td class="event-cell" data-date="${dateStr}" data-event-type="O">${hasO ? '<span class="check event-o">‚úì</span>' : ''}</td>
                        </tr>`;
                });
            };

            const renderCalendar = () => {
                const calendarDays = $('#calendar-days');
                calendarDays.innerHTML = '';
                const { year, month } = { year: state.currentDate.getFullYear(), month: state.currentDate.getMonth() };
                $('#month-year').textContent = state.currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                const predictionData = getPredictionData();
                let fertileWindow = { start: null, end: null };
                if (predictionData) {
                     const nextR = new Date(predictionData.lastRDate); nextR.setDate(nextR.getDate() + Math.round(predictionData.avgCycle));
                     const nextO = new Date(nextR); nextO.setDate(nextO.getDate() - state.settings.lutealPhase);
                     fertileWindow.end = nextO;
                     const start = new Date(nextO); start.setDate(start.getDate() - 5);
                     fertileWindow.start = start;
                }
                
                const dayOffset = (new Date(year, month, 1).getDay() + 6) % 7;

                if (!$('#day-names').innerHTML) ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(d => $('#day-names').innerHTML += `<div class="day-name">${d}</div>`);
                for (let i = 0; i < dayOffset; i++) calendarDays.innerHTML += `<div class="day empty" style="visibility:hidden"></div>`;

                const today = new Date();
                for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    const date = new Date(year, month, day);
                    
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${yyyy}-${mm}-${dd}`;

                    const dayEl = document.createElement('div');
                    dayEl.className = 'day'; dayEl.textContent = day; dayEl.dataset.date = dateStr;

                    if (date.toDateString() === today.toDateString()) dayEl.classList.add('today');
                    if (fertileWindow.start && date >= fertileWindow.start && date <= fertileWindow.end) dayEl.classList.add('fertile');
                    
                    if (state.events[dateStr] && state.events[dateStr].types.length > 0) {
                        const dotsContainer = document.createElement('div');
                        dotsContainer.className = 'dots-container';
                        if (state.events[dateStr].types.some(t => ['R','Rd','Rf'].includes(t))) dotsContainer.innerHTML += '<div class="dot r-dot"></div>';
                        if (state.events[dateStr].types.includes('O')) dotsContainer.innerHTML += '<div class="dot o-dot"></div>';
                        if (state.events[dateStr].types.includes('A')) dotsContainer.innerHTML += '<div class="dot a-dot"></div>';
                        dayEl.appendChild(dotsContainer);
                    }
                    dayEl.addEventListener('click', () => openDayModal(dateStr));
                    calendarDays.appendChild(dayEl);
                }
            };
            
            let selectedDateStr = '';
            const openDayModal = (dateStr) => {
                selectedDateStr = dateStr;
                $('#day-modal-title').textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                $('#day-modal-note').value = state.events[dateStr]?.note || '';
                $('#day-modal').classList.remove('hidden');
            };
            const closeDayModal = () => $('#day-modal').classList.add('hidden');
            
            const refreshActiveView = () => {
                const currentView = $('.nav-btn.active')?.dataset.view || 'dashboard';
                navigateTo(currentView);
            };

            const saveDayData = (type) => {
                if (!state.events[selectedDateStr]) state.events[selectedDateStr] = { types: [], note: '' };
                if (!state.events[selectedDateStr].types.includes(type)) state.events[selectedDateStr].types.push(type);
                saveData();
                refreshActiveView();
            };
            
            const toggleEvent = (dateStr, eventType) => {
                if (!state.events[dateStr]) {
                    state.events[dateStr] = { types: [], note: '' };
                }
                const eventTypes = state.events[dateStr].types;
                const rTypes = ['R', 'Rd', 'Rf'];

                const typeExists = eventType === 'R' ? eventTypes.some(t => rTypes.includes(t)) : eventTypes.includes(eventType);

                if (typeExists) {
                    const typesToRemove = eventType === 'R' ? rTypes : [eventType];
                    state.events[dateStr].types = eventTypes.filter(t => !typesToRemove.includes(t));
                } else {
                    eventTypes.push(eventType === 'R' ? 'Rd' : eventType);
                }

                if (state.events[dateStr].types.length === 0 && (!state.events[dateStr].note || !state.events[dateStr].note.trim())) {
                    delete state.events[dateStr];
                }

                saveData();
                refreshActiveView();
            };

            const saveNoteOnly = () => {
                const note = $('#day-modal-note').value;
                if (!state.events[selectedDateStr] && note.trim()) state.events[selectedDateStr] = { types: [], note: '' };
                if(state.events[selectedDateStr]) state.events[selectedDateStr].note = note;
                saveData();
            };
            const removeDayEvents = () => {
                if (state.events[selectedDateStr]) {
                    delete state.events[selectedDateStr];
                    saveData();
                    refreshActiveView();
                }
            };
            
            const addPeakDates = () => {
                const predictionData = getPredictionData();
                if (!predictionData) {
                    alert("Pas assez de donn√©es pour ajouter les pics. Assurez-vous d'avoir au moins deux √©v√©nements 'Mode Rd'.");
                    return;
                }

                let addedCount = 0;
                const cycleStarts = predictionData.cycleAnchorEvents;

                for (let i = 1; i < cycleStarts.length; i++) {
                    const cycleStartDate = new Date(cycleStarts[i]);
                    let supposedODate = new Date(cycleStartDate);
                    supposedODate.setDate(supposedODate.getDate() - state.settings.lutealPhase);

                    const yyyy = supposedODate.getFullYear();
                    const mm = String(supposedODate.getMonth() + 1).padStart(2, '0');
                    const dd = String(supposedODate.getDate()).padStart(2, '0');
                    const dateStr = `${yyyy}-${mm}-${dd}`;

                    if (!state.events[dateStr] || !state.events[dateStr].types.includes('O')) {
                        if (!state.events[dateStr]) {
                            state.events[dateStr] = { types: ['O'], note: 'Pic ajout√© auto.' };
                        } else {
                            state.events[dateStr].types.push('O');
                        }
                        addedCount++;
                    }
                }

                if (addedCount > 0) {
                    saveData();
                    alert(`${addedCount} pic(s) d'ovulation manquant(s) ont √©t√© ajout√©s √† votre historique.`);
                    refreshActiveView();
                } else {
                    alert("Aucun pic manquant n'a √©t√© trouv√©. Votre historique semble √† jour !");
                }
            };


            const init = () => {
                document.body.addEventListener('click', resetInactivityTimer);
                $$('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));
                
                $('#lock-btn').addEventListener('click', lockApp);
                $('#prev-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); });
                $('#next-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); });
                
                $('#refresh-dashboard-btn').addEventListener('click', () => {
                    renderDashboard();
                    const btn = $('#refresh-dashboard-btn');
                    btn.textContent = 'Calculs √† jour !';
                    setTimeout(() => {
                        btn.textContent = 'üîÑ Actualiser les calculs';
                    }, 1500);
                });

                $('#add-peak-dates-btn').addEventListener('click', addPeakDates);

                $('#add-r-event').addEventListener('click', () => { saveDayData('R'); closeDayModal(); });
                $('#add-rd-event').addEventListener('click', () => { saveDayData('Rd'); closeDayModal(); });
                $('#add-rf-event').addEventListener('click', () => { saveDayData('Rf'); closeDayModal(); });
                $('#add-o-event').addEventListener('click', () => { saveDayData('O'); closeDayModal(); });
                $('#add-a-event').addEventListener('click', () => { saveDayData('A'); closeDayModal(); });
                $('#remove-event').addEventListener('click', () => { removeDayEvents(); closeDayModal(); });
                $('#save-note-btn').addEventListener('click', () => { saveNoteOnly(); closeDayModal(); });
                $('#close-day-modal-btn').addEventListener('click', closeDayModal);

                $('#save-settings-btn').addEventListener('click', () => { state.settings.lutealPhase = parseInt($('#luteal-phase-duration').value) || 14; saveData(); alert('Param√®tres enregistr√©s !'); refreshActiveView(); });
                $('#export-btn').addEventListener('click', () => { $('#export-data-field').value = JSON.stringify({state: state, pin: localStorage.getItem(PIN_KEY)}); alert('Code de sauvegarde g√©n√©r√©.'); });
                $('#import-btn').addEventListener('click', () => {
                    if(!confirm("Importer √©crasera vos donn√©es. Continuer ?")) return;
                    try {
                        const data = JSON.parse($('#import-data-field').value);
                        localStorage.setItem(APP_DATA_KEY, JSON.stringify(data.state));
                        localStorage.setItem(PIN_KEY, data.pin);
                        alert('Importation r√©ussie !'); location.reload();
                    } catch (e) { alert('Erreur d\'importation.'); }
                });
                $('#reset-app-btn').addEventListener('click', () => { if (confirm("Voulez-vous vraiment tout r√©initialiser ?")) { localStorage.clear(); location.reload(); } });
                
                $('#journal-table').addEventListener('click', (e) => {
                    const cell = e.target.closest('.event-cell');
                    if (cell) {
                        toggleEvent(cell.dataset.date, cell.dataset.eventType);
                    }
                });

                $('.calc-keys').addEventListener('click', (e) => {
                    if (!e.target.matches('button')) return;
                    const key = e.target.dataset.key;
                    const d = $('#calc-display');
                    if (key === '=') { if (d.textContent === localStorage.getItem(PIN_KEY)) unlockApp(); else try { d.textContent = eval(d.textContent.replace(/√ó/g, '*').replace(/√∑/g, '/')) || '0'; } catch { d.textContent = 'Erreur'; } }
                    else if (key === 'clear') d.textContent = '0';
                    else if (key === 'backspace') d.textContent = d.textContent.slice(0, -1) || '0';
                    else d.textContent = (d.textContent === '0' && !'*/+-%'.includes(key)) ? e.target.textContent : d.textContent + e.target.textContent;
                });

                if (!localStorage.getItem(PIN_KEY)) $('#setup-modal').classList.remove('hidden');
                else loadData();
                $('#pincode-submit').addEventListener('click', () => {
                    const pin = $('#pincode-input').value;
                    if (pin.length === 4 && /^\d+$/.test(pin)) {
                        localStorage.setItem(PIN_KEY, pin);
                        $('#setup-modal').classList.add('hidden');
                        if (Object.keys(state.events).length === 0) $('#onboarding-modal').classList.remove('hidden');
                    } else alert("Code invalide.");
                });
                
                $('#start-onboarding-btn').addEventListener('click', () => {
                    const initialHistory = {
                        '2025-05-13': ['A'],'2025-05-19': ['A'],'2025-05-24': ['A'],
                        '2025-06-03': ['A'],'2025-06-06': ['A'],'2025-06-11': ['A'],'2025-06-17': ['A'],
                        '2025-06-21': ['A', 'O'], '2025-07-20': ['A'], '2025-07-28': ['A', 'O'],
                        '2025-08-18': ['A'],'2025-08-23': ['A'],'2025-08-27': ['A'],
                        '2025-09-07': ['A', 'Rd'],'2025-09-10': ['A'],
                        '2025-09-30': ['A', 'Rd'],'2025-10-01': ['R'],
                        '2025-10-04': ['A'],'2025-10-15': ['A'],
                        '2025-10-27': ['A', 'Rd'],'2025-10-28': ['A', 'R'],
                        '2025-11-03': ['A'],'2025-11-04': ['A'],'2025-11-11': ['A']
                    };
                    for(const date in initialHistory){
                        state.events[date] = { types: initialHistory[date], note: 'Import initial' };
                    }
                    saveData();
                    $('#onboarding-modal').classList.add('hidden');
                    alert('Configuration avec historique complet termin√©e !');
                });
            };

            init();
        });
    </script>

</body>
</html>
