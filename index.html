<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculatrice</title>
    <meta name="description" content="Une application de calculatrice simple et efficace.">
    <meta name="theme-color" content="#ffffff">

    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhbGN1bGF0cmljZSIsCiAgInNob3J0X25hbWUiOiAiQ2FsYyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmVmZWZlIiwKICAidGhlbWVfY29sb3IiOiAiI2ZlZmVmZSIsCiAgImRlc2NyaXB0aW9uIjogIlV×’×¢IGNhbGN1bGF0cmljZSBzaW1wbGUuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaWNvbi0xOTJ4MTkyLnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJpY29uLTUxMng1MTIucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --main-color: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --operator-bg: #f79526;
            --number-bg: #e0e0e0;
            --special-bg: #d6d6d6;
            --event-r-color: #007bff;
            --event-o-color: #ff9800;
            --event-a-color: #e83e8c;
            --event-v-color: #6c757d;
            --star-color: #f39c12;
            --btn-secondary-bg: #6c757d;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        .app-container {
            width: 100%; max-width: 400px;
            height: 100%; max-height: 700px;
            background: var(--main-color);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        #calculator-app { display: flex; flex-direction: column; height: 100%; }
        .calc-display {
            background-color: #2a2a2a; color: white;
            font-size: 2.8em; text-align: right; padding: 20px;
            flex: 1; display: flex; align-items: flex-end; justify-content: flex-end;
            word-wrap: break-word; word-break: break-all;
        }
        .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background-color: #ccc; }
        .calc-keys button { background-color: var(--number-bg); border: none; font-size: 1.5em; padding: 20px 0; cursor: pointer; }
        .calc-keys .operator { background-color: var(--operator-bg); color: white; }
        .calc-keys .special { background-color: var(--special-bg); }

        #tracker-app { display: flex; flex-direction: column; height: 100%; }
        header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        header h1 { font-size: 1.5em; }
        #lock-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        nav { display: flex; justify-content: space-around; background: #f9f9f9; padding: 10px 0; }
        nav button { background: none; border: none; font-size: 0.9em; cursor: pointer; color: #777; padding: 5px 10px;}
        nav button.active { color: var(--primary-color); font-weight: bold; border-bottom: 2px solid var(--primary-color); }
        .content-view { flex: 1; overflow-y: auto; padding: 15px; }

        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day { padding: 8px 0; cursor: pointer; border-radius: 50%; position: relative; }
        .day.today { background-color: var(--primary-color); color: white; font-weight: bold;}
        .day.fertile { background-color: #e83e8c1a; border-radius: 0; }
        .day.voyage { text-decoration: line-through; color: #aaa; background-color: #f0f0f0; }
        .dots-container { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); display: flex; gap: 2px; }
        .dot { width: 5px; height: 5px; border-radius: 50%; }
        .r-dot { background-color: var(--event-r-color); }
        .o-dot { background-color: var(--event-o-color); }
        .a-dot { background-color: var(--event-a-color); }
        .v-dot { background-color: var(--event-v-color); }

        #journal-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        #journal-table th, #journal-table td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        #journal-table th { background-color: #f9f9f9; }
        #journal-table .event-cell { cursor: pointer; user-select: none; }
        #journal-table .event-cell:hover { background-color: #f0f0f0; }
        .check { font-weight: bold; }
        .check.event-r { color: var(--event-r-color); }
        .check.event-o { color: var(--event-o-color); }
        .check.event-a { color: var(--event-a-color); }
        .check.event-v { color: var(--event-v-color); }
        
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: var(--primary-color); color: white; width: 100%; margin-top: 10px; font-size: 1em; }
        .btn-danger { background-color: #dc3545; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; }
        #day-modal-events { display: flex; flex-direction: column; gap: 8px; }
        #day-modal-events .btn-group { display: flex; gap: 8px; }
        #day-modal-events .btn-group button { flex: 1; }
        #day-modal-note { width: 100%; height: 60px; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="calculator-app">
            <div id="calc-display" class="calc-display">0</div>
            <div class="calc-keys">
                <button class="special" data-key="clear">AC</button><button class="special" data-key="backspace">âŒ«</button><button class="special" data-key="%">%</button><button class="operator" data-key="/">Ã·</button>
                <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button class="operator" data-key="*">Ã—</button>
                <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button class="operator" data-key="-">-</button>
                <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button class="operator" data-key="+">+</button>
                <button data-key="0" style="grid-column: span 2;">0</button><button data-key=".">.</button><button class="operator" data-key="=">=</button>
            </div>
        </div>

        <div id="tracker-app" class="hidden">
            <header><h1>Journal</h1><button id="lock-btn">ðŸ”’</button></header>
            <nav>
                <button class="nav-btn active" data-view="journal">Journal</button>
                <button class="nav-btn" data-view="calendar">Calendrier</button>
                <button class="nav-btn" data-view="settings">ParamÃ¨tres</button>
            </nav>
            
            <div id="journal-view" class="content-view"><table id="journal-table"><thead><tr><th>Date</th><th>A</th><th>R</th><th>O</th><th>V</th></tr></thead><tbody></tbody></table></div>
            <div id="calendar-view" class="content-view hidden"><div id="calendar-header"><button id="prev-month">â—„</button><span id="month-year"></span><button id="next-month">â–º</button></div><div class="calendar-grid" id="day-names"></div><div class="calendar-grid" id="calendar-days"></div></div>
            <div id="settings-view" class="content-view hidden">
                <div class="settings-group">
                    <label for="luteal-phase-duration">DurÃ©e phase post-signal (jours)</label>
                    <input type="number" id="luteal-phase-duration" value="14" min="10" max="20">
                </div>
                <button id="save-settings-btn" class="btn">Enregistrer</button>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <div class="settings-group">
                    <h3>Actions</h3>
                    <button id="add-peak-dates-btn" class="btn" style="background-color: var(--event-o-color);">Ajouter les Pics R/O manquants</button>
                </div>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <div class="settings-group">
                    <h3>Exporter / Sauvegarder</h3>
                    <textarea id="export-data-field" readonly rows="4"></textarea>
                    <button id="export-btn" class="btn">GÃ©nÃ©rer le code</button>
                </div>
                <div class="settings-group">
                    <h3>Importer une Sauvegarde</h3>
                    <textarea id="import-data-field" rows="4"></textarea>
                    <button id="import-btn" class="btn">Importer</button>
                </div>
                <hr style="margin: 20px 0; border: 1px solid #eee;">
                <button id="reset-app-btn" class="btn btn-danger">RÃ©initialiser</button>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="day-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="day-modal-title"></h2>
            <div id="day-modal-events">
                 <div class="btn-group">
                    <button id="add-rd-event" class="btn">Mode Rd (dÃ©but)</button>
                    <button id="add-rf-event" class="btn" style="background-color: var(--btn-secondary-bg);">Mode Rf (fin)</button>
                 </div>
                 <button id="add-r-event" class="btn" style="background-color: var(--btn-secondary-bg);">Mode R (isolÃ©)</button>
                 <button id="add-o-event" class="btn" style="background-color: var(--event-o-color);">Mode O</button>
                 <button id="add-a-event" class="btn" style="background-color: var(--event-a-color);">Ajouter Mode A</button>
                 <button id="add-v-event" class="btn" style="background-color: var(--event-v-color);">Ajouter Mode V</button>
                 <button id="remove-event" class="btn btn-danger">Supprimer les Ã©vÃ©nements</button>
            </div>
            <textarea id="day-modal-note" placeholder="Ajouter une note..."></textarea>
            <button id="save-note-btn" class="btn">Enregistrer</button>
            <button id="close-day-modal-btn" class="btn" style="background: var(--btn-secondary-bg); margin-top:5px;">Fermer</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const APP_DATA_KEY = 'discreetAppData_v13';
            const PIN_KEY = 'discreetAppPin_v13';
            let inactivityTimer;

            // DonnÃ©es directement intÃ©grÃ©es dans l'Ã©tat initial
            let state = {
                currentDate: new Date("2025-11-16T13:52:57.274Z"),
                events: {
                    "2025-05-13":{"types":["A"],"note":"Import initial"},
                    "2025-05-19":{"types":["A"],"note":"Import initial"},
                    "2025-05-24":{"types":["A"],"note":"Import initial"},
                    "2025-06-03":{"types":["A"],"note":"Import initial"},
                    "2025-06-06":{"types":["A"],"note":"Import initial"},
                    "2025-06-11":{"types":["A"],"note":"Import initial"},
                    "2025-06-17":{"types":["A"],"note":"Import initial"},
                    "2025-06-21":{"types":["A"],"note":"Import initial"},
                    "2025-07-20":{"types":["A"],"note":"Import initial"},
                    "2025-07-28":{"types":["A"],"note":"Import initial"},
                    "2025-08-18":{"types":["A"],"note":"Import initial"},
                    "2025-08-23":{"types":["A"],"note":"Import initial"},
                    "2025-08-27":{"types":["A"],"note":"Import initial"},
                    "2025-09-07":{"types":["A","Rd"],"note":"Import initial"},
                    "2025-09-10":{"types":["A"],"note":"Import initial"},
                    "2025-09-30":{"types":["A","Rd"],"note":"Import initial"},
                    "2025-10-01":{"types":["R","A"],"note":"Import initial"},
                    "2025-10-04":{"types":["A"],"note":"Import initial"},
                    "2025-10-15":{"types":["A"],"note":"Import initial"},
                    "2025-10-28":{"types":["A","R"],"note":"Import initial"},
                    "2025-11-03":{"types":["A"],"note":"Import initial"},
                    "2025-11-04":{"types":["A"],"note":"Import initial"},
                    "2025-11-11":{"types":["A"],"note":"Import initial"},
                    "2025-10-27":{"types":["A","R"],"note":""},
                    "2025-09-16":{"types":[],"note":"Pic ajoutÃ© auto."},
                    "2025-11-23":{"types":["Rd","V"],"note":""},
                    "2025-11-09":{"types":["O"],"note":""},
                    "2025-11-24":{"types":["R","V"],"note":""},
                    "2025-12-22":{"types":["R"],"note":""},
                    "2025-12-07":{"types":["O","V"],"note":""},
                    "2025-12-08":{"types":["V"],"note":""},
                    "2025-12-09":{"types":["V"],"note":""},
                    "2025-12-10":{"types":["V"],"note":""},
                    "2025-12-11":{"types":["V"],"note":""},
                    "2025-12-12":{"types":["V"],"note":""},
                    "2025-12-13":{"types":["V"],"note":""},
                    "2025-12-14":{"types":["V"],"note":""},
                    "2025-11-22":{"types":["V"],"note":""},
                    "2025-11-25":{"types":["V"],"note":""},
                    "2025-11-26":{"types":["V"],"note":""}
                },
                settings: { lutealPhase: 14 }
            };

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);

            const saveData = () => localStorage.setItem(APP_DATA_KEY, JSON.stringify(state));
            const loadData = () => {
                const data = localStorage.getItem(APP_DATA_KEY);
                if (data) {
                    const loaded = JSON.parse(data);
                    state = { ...state, ...loaded, settings: { ...state.settings, ...loaded.settings } };
                    state.currentDate = new Date(state.currentDate);
                } else {
                    // Si aucune donnÃ©e n'est dans le localStorage, on sauvegarde l'Ã©tat initial
                    saveData();
                }
                $('#luteal-phase-duration').value = state.settings.lutealPhase;
            };

            const lockApp = () => { $('#tracker-app').classList.add('hidden'); $('#calculator-app').classList.remove('hidden'); $('#calc-display').textContent = '0'; clearTimeout(inactivityTimer); };
            const unlockApp = () => { $('#calculator-app').classList.add('hidden'); $('#tracker-app').classList.remove('hidden'); navigateTo('journal'); startInactivityTimer(); };
            const startInactivityTimer = () => { clearTimeout(inactivityTimer); inactivityTimer = setTimeout(lockApp, 5 * 60 * 1000); };
            const resetInactivityTimer = () => startInactivityTimer();
            
            const navigateTo = (viewName) => {
                const titles = { journal: 'Journal', calendar: 'Calendrier', settings: 'ParamÃ¨tres' };
                $('header h1').textContent = titles[viewName];
                $$('.content-view').forEach(v => v.classList.add('hidden'));
                $(`#${viewName}-view`).classList.remove('hidden');
                $$('.nav-btn').forEach(b => b.classList.remove('active'));
                $(`.nav-btn[data-view="${viewName}"]`).classList.add('active');
                if (viewName === 'calendar') renderCalendar();
                if (viewName === 'journal') renderJournalView();
            };
            
            const getPredictionData = () => {
                const cycleAnchorEvents = Object.keys(state.events)
                    .filter(date => state.events[date] && state.events[date].types.includes('Rd'))
                    .sort((a, b) => new Date(a) - new Date(b));

                if (cycleAnchorEvents.length < 2) return null;

                const cycleLengths = [];
                for (let i = 1; i < cycleAnchorEvents.length; i++) {
                    const diff = new Date(cycleAnchorEvents[i]) - new Date(cycleAnchorEvents[i - 1]);
                    cycleLengths.push(diff / (1000 * 60 * 60 * 24));
                }
                const avgCycle = cycleLengths.reduce((a, b) => a + b, 0) / cycleLengths.length;
                
                return {
                    avgCycle,
                    lastRDate: new Date(cycleAnchorEvents[cycleAnchorEvents.length - 1]),
                };
            };
            
            const renderJournalView = () => {
                const tableBody = $('#journal-table tbody');
                tableBody.innerHTML = '';
                let logData = {};

                for (const dateStr in state.events) {
                    if (state.events[dateStr] && state.events[dateStr].types) {
                        logData[dateStr] = [...state.events[dateStr].types];
                    }
                }
                
                const allDates = Object.keys(logData).sort((a, b) => new Date(b) - new Date(a));

                allDates.forEach(dateStr => {
                    const events = logData[dateStr] || [];
                    const currentDate = new Date(dateStr + 'T00:00:00');
                    const hasA = events.includes('A');
                    const hasR = events.some(type => ['R', 'Rd', 'Rf'].includes(type));
                    const hasO = events.includes('O');
                    const hasV = events.includes('V');

                    tableBody.innerHTML += `
                        <tr>
                            <td>${currentDate.toLocaleDateString('fr-FR')}</td>
                            <td class="event-cell" data-date="${dateStr}" data-event-type="A">${hasA ? '<span class="check event-a">âœ“</span>' : ''}</td>
                            <td class="event-cell" data-date="${dateStr}" data-event-type="R">${hasR ? '<span class="check event-r">âœ“</span>' : ''}</td>
                            <td class="event-cell" data-date="${dateStr}" data-event-type="O">${hasO ? '<span class="check event-o">âœ“</span>' : ''}</td>
                            <td class="event-cell" data-date="${dateStr}" data-event-type="V">${hasV ? '<span class="check event-v">âœ“</span>' : ''}</td>
                        </tr>`;
                });
            };

            const renderCalendar = () => {
                const calendarDays = $('#calendar-days');
                calendarDays.innerHTML = '';
                const { year, month } = { year: state.currentDate.getFullYear(), month: state.currentDate.getMonth() };
                $('#month-year').textContent = state.currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                const predictionData = getPredictionData();
                let fertileWindow = { start: null, end: null };
                if (predictionData) {
                     const nextR = new Date(predictionData.lastRDate); nextR.setDate(nextR.getDate() + Math.round(predictionData.avgCycle));
                     const nextO = new Date(nextR); nextO.setDate(nextO.getDate() - state.settings.lutealPhase);
                     fertileWindow.end = nextO;
                     const start = new Date(nextO); start.setDate(start.getDate() - 5);
                     fertileWindow.start = start;
                }
                
                const dayOffset = (new Date(year, month, 1).getDay() + 6) % 7;

                if (!$('#day-names').innerHTML) ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(d => $('#day-names').innerHTML += `<div class="day-name">${d}</div>`);
                for (let i = 0; i < dayOffset; i++) calendarDays.innerHTML += `<div class="day empty" style="visibility:hidden"></div>`;

                const today = new Date();
                for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    const date = new Date(year, month, day);
                    
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${yyyy}-${mm}-${dd}`;

                    const dayEl = document.createElement('div');
                    dayEl.className = 'day'; dayEl.textContent = day; dayEl.dataset.date = dateStr;

                    if (date.toDateString() === today.toDateString()) dayEl.classList.add('today');
                    if (fertileWindow.start && date >= fertileWindow.start && date <= fertileWindow.end) dayEl.classList.add('fertile');
                    
                    if (state.events[dateStr] && state.events[dateStr].types.length > 0) {
                        const dotsContainer = document.createElement('div');
                        dotsContainer.className = 'dots-container';
                        if (state.events[dateStr].types.some(t => ['R','Rd','Rf'].includes(t))) dotsContainer.innerHTML += '<div class="dot r-dot"></div>';
                        if (state.events[dateStr].types.includes('O')) dotsContainer.innerHTML += '<div class="dot o-dot"></div>';
                        if (state.events[dateStr].types.includes('A')) dotsContainer.innerHTML += '<div class="dot a-dot"></div>';
                        if (state.events[dateStr].types.includes('V')) {
                             dotsContainer.innerHTML += '<div class="dot v-dot"></div>';
                             dayEl.classList.add('voyage');
                        }
                        dayEl.appendChild(dotsContainer);
                    }
                    dayEl.addEventListener('click', () => openDayModal(dateStr));
                    calendarDays.appendChild(dayEl);
                }
            };
            
            let selectedDateStr = '';
            const openDayModal = (dateStr) => {
                selectedDateStr = dateStr;
                $('#day-modal-title').textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                $('#day-modal-note').value = state.events[dateStr]?.note || '';
                $('#day-modal').classList.remove('hidden');
            };
            const closeDayModal = () => $('#day-modal').classList.add('hidden');
            
            const refreshActiveView = () => {
                const currentView = $('.nav-btn.active')?.dataset.view || 'journal';
                navigateTo(currentView);
            };

            const saveDayData = (type) => {
                if (!state.events[selectedDateStr]) state.events[selectedDateStr] = { types: [], note: '' };
                if (!state.events[selectedDateStr].types.includes(type)) state.events[selectedDateStr].types.push(type);
                saveData();
                refreshActiveView();
            };
            
            const toggleEvent = (dateStr, eventType) => {
                if (!state.events[dateStr]) {
                    state.events[dateStr] = { types: [], note: '' };
                }
                const eventTypes = state.events[dateStr].types;
                const rTypes = ['R', 'Rd', 'Rf'];

                const typeExists = eventType === 'R' ? eventTypes.some(t => rTypes.includes(t)) : eventTypes.includes(eventType);

                if (typeExists) {
                    const typesToRemove = eventType === 'R' ? rTypes : [eventType];
                    state.events[dateStr].types = eventTypes.filter(t => !typesToRemove.includes(t));
                } else {
                    eventTypes.push(eventType === 'R' ? 'Rd' : eventType);
                }

                if (state.events[dateStr].types.length === 0 && (!state.events[dateStr].note || !state.events[dateStr].note.trim())) {
                    delete state.events[dateStr];
                }

                saveData();
                refreshActiveView();
            };

            const saveNoteOnly = () => {
                const note = $('#day-modal-note').value;
                if (!state.events[selectedDateStr] && note.trim()) state.events[selectedDateStr] = { types: [], note: '' };
                if(state.events[selectedDateStr]) state.events[selectedDateStr].note = note;
                saveData();
            };
            const removeDayEvents = () => {
                if (state.events[selectedDateStr]) {
                    delete state.events[selectedDateStr];
                    saveData();
                    refreshActiveView();
                }
            };
            
            const addPeakDates = () => {
                const predictionData = getPredictionData();
                if (!predictionData) {
                    alert("Pas assez de donnÃ©es pour ajouter les pics. Assurez-vous d'avoir au moins deux Ã©vÃ©nements 'Mode Rd'.");
                    return;
                }

                let addedCount = 0;
                const cycleStarts = predictionData.cycleAnchorEvents;

                for (let i = 1; i < cycleStarts.length; i++) {
                    const cycleStartDate = new Date(cycleStarts[i]);
                    let supposedODate = new Date(cycleStartDate);
                    supposedODate.setDate(supposedODate.getDate() - state.settings.lutealPhase);

                    const yyyy = supposedODate.getFullYear();
                    const mm = String(supposedODate.getMonth() + 1).padStart(2, '0');
                    const dd = String(supposedODate.getDate()).padStart(2, '0');
                    const dateStr = `${yyyy}-${mm}-${dd}`;

                    if (!state.events[dateStr] || !state.events[dateStr].types.includes('O')) {
                        if (!state.events[dateStr]) {
                            state.events[dateStr] = { types: ['O'], note: 'Pic ajoutÃ© auto.' };
                        } else {
                            state.events[dateStr].types.push('O');
                        }
                        addedCount++;
                    }
                }

                if (addedCount > 0) {
                    saveData();
                    alert(`${addedCount} pic(s) d'ovulation manquant(s) ont Ã©tÃ© ajoutÃ©s Ã  votre historique.`);
                    refreshActiveView();
                } else {
                    alert("Aucun pic manquant n'a Ã©tÃ© trouvÃ©. Votre historique semble Ã  jour !");
                }
            };


            const init = () => {
                // Charger les donnÃ©es (soit depuis le localStorage, soit l'Ã©tat initial)
                loadData();
                // Le code PIN '1314' est maintenant la rÃ©fÃ©rence
                const appPin = "1314";
                
                document.body.addEventListener('click', resetInactivityTimer);
                $$('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));
                
                $('#lock-btn').addEventListener('click', lockApp);
                $('#prev-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); });
                $('#next-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); });
                
                $('#add-peak-dates-btn').addEventListener('click', addPeakDates);

                $('#add-r-event').addEventListener('click', () => { saveDayData('R'); closeDayModal(); });
                $('#add-rd-event').addEventListener('click', () => { saveDayData('Rd'); closeDayModal(); });
                $('#add-rf-event').addEventListener('click', () => { saveDayData('Rf'); closeDayModal(); });
                $('#add-o-event').addEventListener('click', () => { saveDayData('O'); closeDayModal(); });
                $('#add-a-event').addEventListener('click', () => { saveDayData('A'); closeDayModal(); });
                $('#add-v-event').addEventListener('click', () => { saveDayData('V'); closeDayModal(); });
                $('#remove-event').addEventListener('click', () => { removeDayEvents(); closeDayModal(); });
                $('#save-note-btn').addEventListener('click', () => { saveNoteOnly(); closeDayModal(); });
                $('#close-day-modal-btn').addEventListener('click', closeDayModal);

                $('#save-settings-btn').addEventListener('click', () => { state.settings.lutealPhase = parseInt($('#luteal-phase-duration').value) || 14; saveData(); alert('ParamÃ¨tres enregistrÃ©s !'); refreshActiveView(); });
                $('#export-btn').addEventListener('click', () => { $('#export-data-field').value = JSON.stringify({state: state, pin: appPin}); alert('Code de sauvegarde gÃ©nÃ©rÃ©.'); });
                $('#import-btn').addEventListener('click', () => {
                    if(!confirm("Importer Ã©crasera vos donnÃ©es. Continuer ?")) return;
                    try {
                        const data = JSON.parse($('#import-data-field').value);
                        localStorage.setItem(APP_DATA_KEY, JSON.stringify(data.state));
                        alert('Importation rÃ©ussie ! L\'application va se recharger.'); location.reload();
                    } catch (e) { alert('Erreur d\'importation.'); }
                });
                $('#reset-app-btn').addEventListener('click', () => { if (confirm("Voulez-vous vraiment tout rÃ©initialiser ?")) { localStorage.clear(); location.reload(); } });
                
                $('#journal-table').addEventListener('click', (e) => {
                    const cell = e.target.closest('.event-cell');
                    if (cell) {
                        toggleEvent(cell.dataset.date, cell.dataset.eventType);
                    }
                });

                $('.calc-keys').addEventListener('click', (e) => {
                    if (!e.target.matches('button')) return;
                    const key = e.target.dataset.key;
                    const d = $('#calc-display');
                    if (key === '=') { if (d.textContent === appPin) unlockApp(); else try { d.textContent = eval(d.textContent.replace(/Ã—/g, '*').replace(/Ã·/g, '/')) || '0'; } catch { d.textContent = 'Erreur'; } }
                    else if (key === 'clear') d.textContent = '0';
                    else if (key === 'backspace') d.textContent = d.textContent.slice(0, -1) || '0';
                    else d.textContent = (d.textContent === '0' && !'*/+-%'.includes(key)) ? e.target.textContent : d.textContent + e.target.textContent;
                });
            };

            init();
        });
    </script>

</body>
</html>
