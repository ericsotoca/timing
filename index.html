<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculatrice</title>
    <meta name="description" content="Une application de calculatrice simple et efficace.">
    <meta name="theme-color" content="#ffffff">

    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhbGN1bGF0cmljZSIsCiAgInNob3J0X25hbWUiOiAiQ2FsYyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmVmZWZlIiwKICAidGhlbWVfY29sb3IiOiAiI2ZlZmVmZSIsCiAgImRlc2NyaXB0aW9uIjogIlV◊í◊¢IGNhbGN1bGF0cmljZSBzaW1wbGUuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaWNvbi0xOTJ4MTkyLnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJpY29uLTUxMng1MTIucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --main-color: #ffffff;
            --text-color: #333;
            --primary-color: #007bff;
            --operator-bg: #f79526;
            --number-bg: #e0e0e0;
            --special-bg: #d6d6d6;
            --event-r-color: #007bff;
            --event-o-color: #ff9800;
            --star-color: #f39c12;
            --btn-secondary-bg: #6c757d;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        .app-container {
            width: 100%; max-width: 400px;
            height: 100%; max-height: 700px;
            background: var(--main-color);
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        #calculator-app { display: flex; flex-direction: column; height: 100%; }
        .calc-display {
            background-color: #2a2a2a; color: white;
            font-size: 2.8em; text-align: right; padding: 20px;
            flex: 1; display: flex; align-items: flex-end; justify-content: flex-end;
            word-wrap: break-word; word-break: break-all;
        }
        .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background-color: #ccc; }
        .calc-keys button {
            background-color: var(--number-bg); border: none; font-size: 1.5em;
            padding: 20px 0; cursor: pointer; transition: background-color 0.2s;
        }
        .calc-keys button:active { background-color: #c0c0c0; }
        .calc-keys .operator { background-color: var(--operator-bg); color: white; }
        .calc-keys .special { background-color: var(--special-bg); }

        #tracker-app { display: flex; flex-direction: column; height: 100%; }
        header { 
            padding: 15px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #eee;
        }
        header h1 { font-size: 1.5em; }
        #lock-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        nav { display: flex; justify-content: space-around; background: #f9f9f9; padding: 10px 0; }
        nav button { background: none; border: none; font-size: 1em; cursor: pointer; color: #777; padding: 5px 10px;}
        nav button.active { color: var(--primary-color); font-weight: bold; border-bottom: 2px solid var(--primary-color); }
        .content-view { flex: 1; overflow-y: auto; padding: 15px; }

        .predictions-container {
            display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px;
        }
        .prediction-card {
            background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center;
        }
        .prediction-card h4 { font-size: 1em; color: #555; margin-bottom: 5px; }
        .prediction-date { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .prediction-countdown { font-size: 0.9em; color: #777; margin-bottom: 10px; }
        .confidence-stars { font-size: 1.2em; color: var(--star-color); }

        .dashboard-card { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .dashboard-card h3 { margin-bottom: 10px; font-size: 1.1em; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #history-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        #history-list li { padding: 8px 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        #history-list li:last-child { border-bottom: none; }
        #history-list .event-r { color: var(--event-r-color); font-weight: bold; }
        #history-list .event-o { color: var(--event-o-color); font-weight: bold; }
        .supposed-event { font-style: italic; color: #666; }

        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #calendar-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 5px; }
        #month-year { font-size: 1.2em; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-name { font-weight: bold; color: #999; font-size: 0.8em; }
        .day { padding: 8px 0; cursor: pointer; border-radius: 50%; position: relative; transition: background-color 0.2s; }
        .day.today { background-color: var(--primary-color); color: white; font-weight: bold;}
        .event-dot { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; }
        .r-dot { background-color: var(--event-r-color); }
        .o-dot { background-color: var(--event-o-color); }

        .settings-group { margin-bottom: 20px; }
        .settings-group label { display: block; margin-bottom: 5px; }
        .settings-group input, .settings-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: var(--primary-color); color: white; width: 100%; margin-top: 10px; font-size: 1em; }
        .btn-danger { background-color: #dc3545; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; }
        #day-modal-events { display: flex; flex-direction: column; gap: 8px; }
        #day-modal-events .btn-group { display: flex; gap: 8px; }
        #day-modal-events .btn-group button { flex: 1; }
        #day-modal-note { width: 100%; height: 60px; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="calculator-app">
            <div id="calc-display" class="calc-display">0</div>
            <div class="calc-keys">
                <button class="special" data-key="clear">AC</button><button class="special" data-key="backspace">‚å´</button><button class="special" data-key="%">%</button><button class="operator" data-key="/">√∑</button>
                <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button class="operator" data-key="*">√ó</button>
                <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button class="operator" data-key="-">-</button>
                <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button class="operator" data-key="+">+</button>
                <button data-key="0" style="grid-column: span 2;">0</button><button data-key=".">.</button><button class="operator" data-key="=">=</button>
            </div>
        </div>

        <div id="tracker-app" class="hidden">
            <header><h1>Tableau de bord</h1><button id="lock-btn">üîí</button></header>
            <nav>
                <button class="nav-btn active" data-view="dashboard">Tableau de bord</button>
                <button class="nav-btn" data-view="calendar">Calendrier</button>
                <button class="nav-btn" data-view="settings">Param√®tres</button>
            </nav>

            <div id="dashboard-view" class="content-view"><div id="predictions-container" class="predictions-container"></div><div class="dashboard-card"><h3>Historique des √©v√©nements</h3><ul id="history-list"></ul></div></div>
            <div id="calendar-view" class="content-view hidden"><div id="calendar-header"><button id="prev-month">‚óÑ</button><span id="month-year"></span><button id="next-month">‚ñ∫</button></div><div class="calendar-grid" id="day-names"></div><div class="calendar-grid" id="calendar-days"></div></div>
            <div id="settings-view" class="content-view hidden"><div class="settings-group"><label for="luteal-phase-duration">Dur√©e phase post-signal (jours)</label><input type="number" id="luteal-phase-duration" value="14" min="10" max="20"></div><button id="save-settings-btn" class="btn">Enregistrer</button><hr style="margin: 20px 0; border: 1px solid #eee;"><div class="settings-group"><h3>Exporter / Sauvegarder</h3><textarea id="export-data-field" readonly rows="4"></textarea><button id="export-btn" class="btn">G√©n√©rer le code</button></div><div class="settings-group"><h3>Importer une Sauvegarde</h3><textarea id="import-data-field" rows="4"></textarea><button id="import-btn" class="btn">Importer</button></div><hr style="margin: 20px 0; border: 1px solid #eee;"><button id="reset-app-btn" class="btn btn-danger">R√©initialiser</button></div>
        </div>
    </div>

    <!-- Modales -->
    <div id="setup-modal" class="modal-overlay hidden"><div class="modal-content"><h2>D√©finir votre code secret</h2><p>Entrez un code √† 4 chiffres.</p><input type="password" id="pincode-input" maxlength="4" pattern="\d*" inputmode="numeric"><button id="pincode-submit" class="btn">D√©finir</button></div></div>
    <div id="onboarding-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Configuration Initiale</h2><p>Ajout de votre historique d'√©v√©nements "Mode R".</p><button id="start-onboarding-btn" class="btn">Commencer</button></div></div>
    <div id="day-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="day-modal-title"></h2>
            <div id="day-modal-events">
                 <div class="btn-group">
                    <button id="add-rd-event" class="btn">Mode Rd (d√©but)</button>
                    <button id="add-rf-event" class="btn" style="background-color: var(--btn-secondary-bg);">Mode Rf (fin)</button>
                 </div>
                 <button id="add-r-event" class="btn" style="background-color: var(--btn-secondary-bg);">Mode R (isol√©)</button>
                 <button id="add-o-event" class="btn" style="background-color: var(--event-o-color);">Mode O</button>
                 <button id="remove-event" class="btn btn-danger">Supprimer l'√©v√©nement</button>
            </div>
            <textarea id="day-modal-note" placeholder="Ajouter une note..."></textarea>
            <button id="save-note-btn" class="btn">Enregistrer</button>
            <button id="close-day-modal-btn" class="btn" style="background: var(--btn-secondary-bg); margin-top:5px;">Fermer</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const APP_DATA_KEY = 'discreetAppData_v6';
            const PIN_KEY = 'discreetAppPin_v6';
            let inactivityTimer;

            let state = {
                currentDate: new Date(),
                events: {},
                settings: { lutealPhase: 14 }
            };

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);

            const saveData = () => localStorage.setItem(APP_DATA_KEY, JSON.stringify(state));
            const loadData = () => {
                const data = localStorage.getItem(APP_DATA_KEY);
                if (data) {
                    const loaded = JSON.parse(data);
                    state = { ...state, ...loaded, settings: { ...state.settings, ...loaded.settings } };
                    state.currentDate = new Date(state.currentDate);
                }
                $('#luteal-phase-duration').value = state.settings.lutealPhase;
            };

            const lockApp = () => { $('#tracker-app').classList.add('hidden'); $('#calculator-app').classList.remove('hidden'); $('#calc-display').textContent = '0'; clearTimeout(inactivityTimer); };
            const unlockApp = () => { $('#calculator-app').classList.add('hidden'); $('#tracker-app').classList.remove('hidden'); navigateTo('dashboard'); startInactivityTimer(); };
            const startInactivityTimer = () => { clearTimeout(inactivityTimer); inactivityTimer = setTimeout(lockApp, 5 * 60 * 1000); };
            const resetInactivityTimer = () => startInactivityTimer();
            
            const navigateTo = (viewName) => {
                const titles = { dashboard: 'Tableau de bord', calendar: 'Calendrier', settings: 'Param√®tres' };
                $('header h1').textContent = titles[viewName];
                $$('.content-view').forEach(v => v.classList.add('hidden'));
                $(`#${viewName}-view`).classList.remove('hidden');
                $$('.nav-btn').forEach(b => b.classList.remove('active'));
                $(`.nav-btn[data-view="${viewName}"]`).classList.add('active');
                if (viewName === 'dashboard') renderDashboard();
                if (viewName === 'calendar') renderCalendar();
            };
            
            const getStandardDeviation = (arr) => {
                if (arr.length < 2) return 0;
                const mean = arr.reduce((a, b) => a + b) / arr.length;
                return Math.sqrt(arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / arr.length);
            };

            const calculateConfidence = (cycleCount, stdDev) => {
                let dataScore = (cycleCount >= 6) ? 2.5 : (cycleCount >= 4) ? 2 : (cycleCount >= 3) ? 1.5 : (cycleCount >= 2) ? 1 : 0.5;
                let consistencyScore = (stdDev <= 1.5) ? 2.5 : (stdDev <= 3) ? 2 : (stdDev <= 5) ? 1.5 : (stdDev <= 7) ? 1 : 0.5;
                return Math.max(1, dataScore + consistencyScore);
            };

            const renderStars = (score) => '‚òÖ'.repeat(Math.round(score)) + '‚òÜ'.repeat(5 - Math.round(score));

            const renderDashboard = () => {
                const predictionsContainer = $('#predictions-container');
                const historyList = $('#history-list');
                predictionsContainer.innerHTML = '';
                historyList.innerHTML = '';
                
                const cycleAnchorEvents = Object.keys(state.events)
                    .filter(date => ['R', 'Rd'].includes(state.events[date].type))
                    .sort((a, b) => new Date(a) - new Date(b));

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let combinedHistory = [];
                for (const dateStr in state.events) combinedHistory.push({ ...state.events[dateStr], date: new Date(dateStr), isSupposed: false });

                if (cycleAnchorEvents.length < 2) {
                    predictionsContainer.innerHTML = `<p style="text-align:center; color: #666;">Ajoutez au moins deux "Mode Rd" pour activer les pr√©dictions.</p>`;
                } else {
                    const cycleLengths = [];
                    for (let i = 1; i < cycleAnchorEvents.length; i++) {
                        const diff = new Date(cycleAnchorEvents[i]) - new Date(cycleAnchorEvents[i-1]);
                        cycleLengths.push(diff / (1000 * 60 * 60 * 24));
                    }
                    const avgCycle = cycleLengths.reduce((a, b) => a + b, 0) / cycleLengths.length;
                    const confidence = calculateConfidence(cycleLengths.length, getStandardDeviation(cycleLengths));
                    const starsHTML = renderStars(confidence);
                    
                    const lastRDate = new Date(cycleAnchorEvents[cycleAnchorEvents.length - 1]);

                    const futurePredictions = [];
                    let currentR = new Date(lastRDate);
                    for (let i = 0; i < 4; i++) {
                        currentR.setDate(currentR.getDate() + Math.round(avgCycle));
                        let predictedO = new Date(currentR);
                        predictedO.setDate(predictedO.getDate() - state.settings.lutealPhase);
                        if (currentR >= today) futurePredictions.push({ type: 'R', date: new Date(currentR) });
                        if (predictedO >= today) futurePredictions.push({ type: 'O', date: new Date(predictedO) });
                    }

                    futurePredictions.sort((a, b) => a.date - b.date).slice(0, 2).forEach(event => {
                        const eventName = event.type === 'R' ? 'Prochain Mode R' : 'Prochain Mode O';
                        const eventColor = event.type === 'R' ? 'var(--event-r-color)' : 'var(--event-o-color)';
                        
                        // --- NOUVELLE LOGIQUE DE PLAGE DE DATES ---
                        const margin = 1; // ¬± 1 jour
                        const startDate = new Date(event.date);
                        startDate.setDate(startDate.getDate() - margin);
                        const endDate = new Date(event.date);
                        endDate.setDate(endDate.getDate() + margin);
                        const dateRangeString = `du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`;
                        
                        // --- NOUVELLE LOGIQUE DE COMPTE √Ä REBOURS ---
                        const daysToStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                        let countdownText = '';
                        if (daysToStart > 1) {
                            countdownText = `Commence dans ${daysToStart} jours`;
                        } else if (daysToStart === 1) {
                            countdownText = `Commence demain`;
                        } else if (today >= startDate && today <= endDate) {
                            countdownText = `En ce moment`;
                        } else if (daysToStart <= 0) {
                             countdownText = `Commence aujourd'hui`;
                        }
                        
                        predictionsContainer.innerHTML += `<div class="prediction-card"><h4>${eventName}</h4><div class="prediction-date" style="color: ${eventColor}">${dateRangeString}</div><div class="prediction-countdown">${countdownText}</div><div class="confidence-stars" title="Indice de confiance : ${confidence.toFixed(1)}/5">${starsHTML}</div></div>`;
                    });
                    
                    const nextPredictedRDate = new Date(lastRDate);
                    nextPredictedRDate.setDate(nextPredictedRDate.getDate() + Math.round(avgCycle));
                    const currentCyclePredictedODate = new Date(nextPredictedRDate);
                    currentCyclePredictedODate.setDate(currentCyclePredictedODate.getDate() - state.settings.lutealPhase);
                    
                    if (currentCyclePredictedODate < today) {
                        const dateStr = currentCyclePredictedODate.toISOString().split('T')[0];
                        if (!state.events[dateStr]) { 
                            combinedHistory.push({ type: 'O', date: currentCyclePredictedODate, isSupposed: true });
                        }
                    }

                    for (let i = 1; i < cycleAnchorEvents.length; i++) {
                        let supposedODate = new Date(cycleAnchorEvents[i]);
                        supposedODate.setDate(supposedODate.getDate() - state.settings.lutealPhase);
                        const dateStr = supposedODate.toISOString().split('T')[0];
                        if (!state.events[dateStr]) {
                             combinedHistory.push({ type: 'O', date: supposedODate, isSupposed: true });
                        }
                    }
                }

                combinedHistory.sort((a, b) => b.date - a.date);
                if (combinedHistory.length > 0) {
                    const nameMap = { R: 'Mode R', Rd: 'Mode R (D√©but)', Rf: 'Mode R (Fin)', O: 'Mode O' };
                    historyList.innerHTML = combinedHistory.map(item => {
                        const eventName = nameMap[item.type] || '√âv√©nement';
                        const eventClass = ['R', 'Rd', 'Rf'].includes(item.type) ? 'event-r' : 'event-o';
                        return `<li><span>${item.date.toLocaleDateString('fr-FR')}</span><strong class="${eventClass} ${item.isSupposed ? 'supposed-event' : ''}">${eventName} ${item.isSupposed ? '*' : ''}</strong></li>`;
                    }).join('');
                } else {
                    historyList.innerHTML = '<li>Aucun √©v√©nement enregistr√©.</li>';
                }
            };

            const renderCalendar = () => {
                const calendarDays = $('#calendar-days');
                calendarDays.innerHTML = '';
                const { year, month } = { year: state.currentDate.getFullYear(), month: state.currentDate.getMonth() };
                $('#month-year').textContent = state.currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const dayOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

                if (!$('#day-names').innerHTML) ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(d => $('#day-names').innerHTML += `<div class="day-name">${d}</div>`);
                for (let i = 0; i < dayOffset; i++) calendarDays.innerHTML += `<div class="day empty"></div>`;

                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'day';
                    dayEl.textContent = day;
                    dayEl.dataset.date = dateStr;

                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                    
                    if (state.events[dateStr]) {
                        const dot = document.createElement('div');
                        const type = state.events[dateStr].type;
                        dot.className = `event-dot ${['R', 'Rd', 'Rf'].includes(type) ? 'r-dot' : 'o-dot'}`;
                        dayEl.appendChild(dot);
                    }
                    dayEl.addEventListener('click', () => openDayModal(dateStr));
                    calendarDays.appendChild(dayEl);
                }
            };
            
            let selectedDateStr = '';
            const openDayModal = (dateStr) => {
                selectedDateStr = dateStr;
                $('#day-modal-title').textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                $('#day-modal-note').value = state.events[dateStr]?.note || '';
                $('#day-modal').classList.remove('hidden');
            };
            const closeDayModal = () => $('#day-modal').classList.add('hidden');
            const saveDayData = (type) => {
                const note = $('#day-modal-note').value;
                state.events[selectedDateStr] = { ...state.events[selectedDateStr], type, note };
                saveData();
                renderCalendar();
            };
            const saveNoteOnly = () => {
                const note = $('#day-modal-note').value;
                if(state.events[selectedDateStr]) state.events[selectedDateStr].note = note;
                else if (note.trim()) state.events[selectedDateStr] = { note };
                saveData();
                renderCalendar();
            };

            const init = () => {
                document.body.addEventListener('click', resetInactivityTimer);
                document.body.addEventListener('keypress', resetInactivityTimer);
                $('#lock-btn').addEventListener('click', lockApp);
                $$('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));
                
                $('#prev-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); });
                $('#next-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); });

                $('#add-r-event').addEventListener('click', () => { saveDayData('R'); closeDayModal(); });
                $('#add-rd-event').addEventListener('click', () => { saveDayData('Rd'); closeDayModal(); });
                $('#add-rf-event').addEventListener('click', () => { saveDayData('Rf'); closeDayModal(); });
                $('#add-o-event').addEventListener('click', () => { saveDayData('O'); closeDayModal(); });
                $('#remove-event').addEventListener('click', () => { delete state.events[selectedDateStr]; saveData(); renderCalendar(); closeDayModal(); });
                $('#save-note-btn').addEventListener('click', () => { saveNoteOnly(); closeDayModal(); });
                $('#close-day-modal-btn').addEventListener('click', closeDayModal);

                $('#save-settings-btn').addEventListener('click', () => { state.settings.lutealPhase = parseInt($('#luteal-phase-duration').value) || 14; saveData(); alert('Param√®tres enregistr√©s !'); });
                $('#export-btn').addEventListener('click', () => { $('#export-data-field').value = JSON.stringify({state: state, pin: localStorage.getItem(PIN_KEY)}); alert('Code de sauvegarde g√©n√©r√©.'); });
                $('#import-btn').addEventListener('click', () => {
                    if(!confirm("Importer √©crasera vos donn√©es. Continuer ?")) return;
                    try {
                        const data = JSON.parse($('#import-data-field').value);
                        localStorage.setItem(APP_DATA_KEY, JSON.stringify(data.state));
                        localStorage.setItem(PIN_KEY, data.pin);
                        alert('Importation r√©ussie !'); location.reload();
                    } catch (e) { alert('Erreur d\'importation.'); }
                });
                $('#reset-app-btn').addEventListener('click', () => { if (confirm("Voulez-vous vraiment tout r√©initialiser ?")) { localStorage.clear(); location.reload(); } });
                
                $('.calc-keys').addEventListener('click', (e) => {
                    if (!e.target.matches('button')) return;
                    const key = e.target.dataset.key;
                    const d = $('#calc-display');
                    if (key === '=') { if (d.textContent === localStorage.getItem(PIN_KEY)) unlockApp(); else try { d.textContent = eval(d.textContent.replace(/√ó/g, '*').replace(/√∑/g, '/')) || '0'; } catch { d.textContent = 'Erreur'; } }
                    else if (key === 'clear') d.textContent = '0';
                    else if (key === 'backspace') d.textContent = d.textContent.slice(0, -1) || '0';
                    else d.textContent = (d.textContent === '0' && !'*/+-%'.includes(key)) ? e.target.textContent : d.textContent + e.target.textContent;
                });

                if (!localStorage.getItem(PIN_KEY)) $('#setup-modal').classList.remove('hidden');
                else loadData();
                $('#pincode-submit').addEventListener('click', () => {
                    const pin = $('#pincode-input').value;
                    if (pin.length === 4 && /^\d+$/.test(pin)) {
                        localStorage.setItem(PIN_KEY, pin);
                        $('#setup-modal').classList.add('hidden');
                        if (Object.keys(state.events).length === 0) $('#onboarding-modal').classList.remove('hidden');
                    } else alert("Code invalide.");
                });
                $('#start-onboarding-btn').addEventListener('click', () => {
                    ['2025-09-07', '2025-10-01', '2025-10-27'].forEach(date => { state.events[date] = { type: 'Rd', note: 'Import initial' }; });
                    saveData();
                    $('#onboarding-modal').classList.add('hidden');
                    alert('Configuration termin√©e !');
                });
            };

            init();
        });
    </script>

</body>
</html>
```
